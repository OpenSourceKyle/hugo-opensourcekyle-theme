{{ define "main" }}

{{/* VALIDATE PAGE FRONT MATTER */}}
{{ $filename := .File.Path }}
{{ $missingFields := slice }}  {{/* Initialize an empty slice for missing fields */}}
{{ if not .Params.title }}
  {{ $missingFields = append $missingFields "title" }}
{{ end }}
{{ if not .Params.date }}
  {{ $missingFields = append $missingFields "date" }}
{{ end }}
{{ if not .Params.tags }}
  {{ $missingFields = append $missingFields "tags" }}
{{ end }}
{{ if not .Params.image }}
  {{ $missingFields = append $missingFields "image" }}
{{ end }}
{{ if not .Params.image_caption }}
  {{ $missingFields = append $missingFields "image_caption" }}
{{ end }}

{{ if gt (len $missingFields) 0 }}  {{/* Only print if there are missing fields */}}
  {{ errorf "ERROR: %q is missing required front matter fields: %s" $filename (delimit $missingFields ", ") }}
{{ end }}

{{/* VALIDATE PAGE CONTENT */}}
{{ if and (eq .Kind "page") (not (in .Params.tags "sitemap")) }}  {{/* Skip validation for pages tagged as sitemap */}}
  {{ if .Content }}  {{/* Ensure content exists before validation */}}
    {{ $pageContent := .Content }}
    {{ $pageFile := .File.Path }}
    {{ $requiredHeaders := partial "required_page_headers.html" }}

    {{ range $requiredHeaders }}
      {{ if not (findRE (printf "^%s" .) $pageContent) }}
        {{ errorf "Missing required header: %s in %s" . $pageFile }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="content-container">
    <div class="card-content">
        <h1>{{ .Title }}</h1>
        {{ partial "author-bubble.html" . }}
        {{ partial "tags.html" . }}

        {{ if in .Params.tags "nsfw" }}
        <div class="disclaimer-box">
            ⚠️ WARNING: ⚠️<br>This page contains <i>Not Safe For Work</i> (NSFW) content.
        </div>
        {{ end }}

        {{ if .Params.image }}
        <div class="featured-image">
            <img src="{{ .Params.image | relURL }}" alt="{{ .Title }}" />
            <i>
                {{ if .Params.image_link }}
                <a href="{{ .Params.image_link }}" target="_blank" class="image-credit">{{ .Params.image_caption }}</a>
                {{ else }}
                {{ .Params.image_caption }}
                {{ end }}
            </i>
        </div>
        {{ end }}
        
        {{ if not .Params.hide_toc }}
        <div class="toc-container">
            <button class="toc-toggle" onclick="toggleTOC()">
                <span class="toc-label">Table of Contents</span>
                <span class="toc-icon">▼</span>
            </button>
            <div id="TableOfContents" class="toc-content">
                {{ .TableOfContents }}
            </div>
        </div>
        {{ end }}

    <div class="page-text" style="color: {{ .Site.Params.colors.paragraphText }}">
        {{ .Content }}
    </div>
</div>

<script>
function isMobile() {
    return window.innerWidth <= 768;
}

function scrollToTop(e) {
    e.preventDefault();
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
    if (isMobile()) {
        toggleTOC();
    }
}

function toggleTOC() {
    const toc = document.querySelector('.toc-content');
    const icon = document.querySelector('.toc-icon');
    toc.classList.toggle('collapsed');
    toc.classList.toggle('active');
    icon.textContent = toc.classList.contains('collapsed') ? '▶' : '▼';
}

// Initialize TOC state on load and resize
function initTOC() {
    const toc = document.querySelector('.toc-content');
    const icon = document.querySelector('.toc-icon');
    if (isMobile() && !toc.classList.contains('collapsed')) {
        toc.classList.add('collapsed');
        icon.textContent = '▶';
    }
}

// Run on page load
document.addEventListener('DOMContentLoaded', initTOC);

// Run on window resize
window.addEventListener('resize', initTOC);

document.querySelectorAll('.toc-content a').forEach(anchor => {
    anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        const headerOffset = document.querySelector('header').offsetHeight;
        const totalOffset = headerOffset + 30; // Added 30px for spacing
        const elementPosition = targetElement.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - totalOffset;

        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    });
});
</script>
{{ end }} 